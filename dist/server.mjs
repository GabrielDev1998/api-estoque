import j from"express";import H from"cors";import*as u from"firebase-admin";var T=()=>{u.apps.length===0&&u.initializeApp({credential:u.credential.cert({clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g,`
`),projectId:process.env.FIREBASE_PROJECT_ID})})};import"dotenv/config";import $ from"express";import L from"express";function U(){return{verifyToken:async e=>{try{let o=await u.auth().verifyIdToken(e);return{uid:o.uid,email:o.email,iat:o.iat,exp:o.exp}}catch(o){throw console.error("Token inv\xE1lido:",o),new Error("Token inv\xE1lido.")}}}}var h=U;var I=L.Router(),{verifyToken:P}=h();I.get("/",async(s,e)=>{let o=s.headers.authorization;if(!o){e.status(401).json({success:!1,error:"Token n\xE3o fornecido."});return}try{let t=o.split("Bearer ")[1],r=await P(t);e.status(200).json({success:!0,user:r})}catch(t){console.error("Token inv\xE1lido:",t),e.status(401).json({success:!1,error:"Token inv\xE1lido ou expirado."});return}});var R=I;import V from"express";import y,{Schema as F}from"mongoose";import g from"mongoose";var C=async(s,e)=>{try{g.connection.readyState===0?(console.log("Conectando ao MongoDB..."),await g.connect(s,{dbName:e}),console.log(`Conectado ao MongoDB na base de dados "${e}"`)):g.connection.readyState===1?console.log("J\xE1 conectado ao MongoDB"):g.connection.readyState===2?console.log("Conex\xE3o com MongoDB est\xE1 em progresso..."):g.connection.readyState===3&&console.log("Desconectando do MongoDB...")}catch(o){throw console.error("Erro ao se conectar ao banco de dados:",o),new Error("Falha ao se conectar ao banco de dados")}},M=C;var m={INVALID_ID:"ID inv\xE1lido.",DOCUMENT_NOT_FOUND:"Documento n\xE3o encontrado.",CREATE_ERROR:"Erro ao criar documento.",UPDATE_ERROR:"Erro ao atualizar documento.",DELETE_ERROR:"Erro ao excluir documento.",LIST_ERROR:"Erro ao listar documentos."};async function k(s,e,o){let t=process.env.MONGODB_URL;if(!t)throw new Error("Vari\xE1vel de ambiente MONGODB_URL n\xE3o encontrada.");await M(t,s);let r=async a=>{try{return y.models[e]||y.model(e,new F(a),o)}catch(i){throw console.error("Erro ao validar o modelo",i.message),new Error("Falha ao validar o modelo")}},c=a=>y.Types.ObjectId.isValid(a),n=(a,i)=>{throw console.error(`Erro ao executar opera\xE7\xE3o: ${a}`,i.message),new Error(a)};return{createDocument:async(a,i)=>{try{let d=await r(a);return await new d(i).save()}catch(d){return n(m.CREATE_ERROR,d),null}},getAllDocument:async()=>{try{return await(await r()).find()}catch(a){n(m.LIST_ERROR,a)}},getDocumentById:async a=>{if(!c(a))throw new Error(m.INVALID_ID);try{let d=await(await r()).findById(a);if(!d)throw new Error(m.DOCUMENT_NOT_FOUND);return d}catch(i){return n(m.DOCUMENT_NOT_FOUND,i),null}},updateDocumentById:async(a,i)=>{if(!c(a))throw new Error(m.INVALID_ID);try{let E=await(await r()).findByIdAndUpdate(a,i,{new:!0});if(!E)throw new Error(m.DOCUMENT_NOT_FOUND);return E}catch(d){n(m.UPDATE_ERROR,d)}},deleteDocumentById:async a=>{if(!c(a))throw new Error(m.INVALID_ID);try{let d=await(await r()).findByIdAndDelete(a);if(!d)throw new Error(m.DOCUMENT_NOT_FOUND);return{id:d._id.toString(),success:!0}}catch(i){n(m.DELETE_ERROR,i)}}}}var f=k;var O=V.Router();O.post("/",async(s,e)=>{let{collectionName:o,schema:t,dbName:r,data:c,nameModel:n}=s.body;if(!t||!c||!r||!n){e.status(400).json({success:!1,error:"Par\xE2metros inv\xE1lidos. Envie schema, data, dbName, nameModel, collectionName (OPCIONAL)"});return}try{let{createDocument:l}=await f(r,n,o),w=await l(t,c);e.json({success:!0,data:w})}catch(l){console.error(l),e.status(500).json({success:!1,error:"Erro ao adicionar documento."})}});var b=O;import q from"express";var N=q.Router();N.get("/all",async(s,e)=>{let{collectionName:o,dbName:t,nameModel:r}=s.query;if(!t||!r||!o){e.status(400).json({success:!1,error:"Algumas dessas informa\xE7\xF5es n\xE3o foram fornecidas: dbName, nameModel e collectionName."});return}try{let{getAllDocument:c}=await f(t,r,o),n=await c();e.json({success:!0,data:n})}catch(c){e.status(500).json({success:!1,error:c.message})}});N.get("/",async(s,e)=>{let{collectionName:o,dbName:t,id:r,nameModel:c}=s.query;if(!t||!r||!o||!c){e.status(400).json({success:!1,error:"Algumas dessas informa\xE7\xF5es n\xE3o foram fornecidas: dbName, id, nameModel e collectionName."});return}try{let{getDocumentById:n}=await f(t,c,o),l=await n(r);e.json({success:!0,data:l})}catch(n){e.status(500).json({success:!1,error:n.message})}});var A=N;import G from"express";var _=G.Router();_.delete("/",async(s,e)=>{let{collectionName:o,dbName:t,id:r,nameModel:c}=s.query;if(!r||!o||!o||!t){e.status(400).json({success:!1,error:"Algumas dessas informa\xE7\xF5es n\xE3o foram fornecidas: id, nameModel, collectionName, dbName."});return}try{let{deleteDocumentById:n}=await f(t,c,o),l=await n(r);e.status(200).json(l)}catch(n){e.status(500).json({success:!1,error:n.message})}});var x=_;import z from"express";var v=z.Router();v.put("/",async(s,e)=>{let o=s.query,{dbName:t,nameModel:r,schema:c,collectionName:n,data:l}=s.body;if(!t||!r||!c||!n||!l){e.status(400).json({success:!1,error:"Algumas dessas informa\xE7\xF5es n\xE3o foram fornecidas: dbName, nameModel, schema, collectionName, data"});return}});var B=v;var p=$.Router();p.get("/",(s,e)=>{e.send("API Sequoia")});p.use("/api/verify-token",R);p.use("/api/mongodb/add",b);p.use("/api/mongodb/get",A);p.use("/api/mongodb/delete",x);p.use("/api/mongodb/update",B);var S=p;var D=j();D.use(H({origin:process.env.ALLOWED_ORIGINS,credentials:!0,methods:["GET","POST","PUT","DELETE","OPTIONS"],allowedHeaders:["Content-Type","Authorization"]}));D.use(j.json());T();D.use("/",S);D.listen(process.env.PORT,()=>{console.log(`API rodando na porta ${process.env.PORT}`)});
